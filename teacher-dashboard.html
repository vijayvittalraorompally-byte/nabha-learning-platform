<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>👨‍🏫 Teacher Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <h1 class="nav-title" id="navTitle">👨‍🏫 Teacher Dashboard</h1>
      <div class="nav-actions">
        <select id="globalLang">
          <option value="en">English</option>
          <option value="pa">ਪੰਜਾਬੀ</option>
        </select>
        <button onclick="authManager.signOut()" class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <!-- Upload Video Section -->
    <section id="uploadSection" class="content-section active">
      <h2 id="uploadTitle">🎥 Upload Video</h2>
      <form id="uploadVideoForm">
        <input type="text" id="videoTitleInput" placeholder="Video Title" required>
        <textarea id="videoDescInput" placeholder="Video Description"></textarea>
        <input type="url" id="videoUrlInput" placeholder="Video URL" required>
        <input type="number" id="videoDurationInput" placeholder="Duration (seconds)">
        <input type="file" id="subtitleFile" accept=".vtt">
        <textarea id="transcriptInput" placeholder="Transcript (English or Punjabi)"></textarea>
        <button type="submit" id="uploadBtn">Upload</button>
      </form>
    </section>

    <!-- Student Progress Section -->
    <section id="studentSection" class="content-section">
      <h2 id="studentTitle">👨‍🎓 Students & Quiz Scores</h2>
      <table class="students-table">
        <thead>
          <tr><th>Name</th><th>Last Active</th><th>Average Score</th><th>Attempts</th></tr>
        </thead>
        <tbody id="studentsTable"><tr><td colspan="4">Loading...</td></tr></tbody>
      </table>
    </section>
  </main>

  <!-- Student Detail Modal -->
  <div id="studentDetailModal" class="upload-modal">
    <div class="modal-inner">
      <h3 id="studentDetailName">Student</h3>
      <table class="students-table">
        <thead>
          <tr><th>Quiz</th><th>Score</th><th>Status</th></tr>
        </thead>
        <tbody id="studentQuizScores">
          <tr><td colspan="3">Loading...</td></tr>
        </tbody>
      </table>
      <div style="margin-top:12px;">
        <button id="closeStudentDetail">Close</button>
      </div>
    </div>
  </div>

  <script src="js/supabase.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/video-handler.js"></script>
  <script>
    const uiTexts = {
      en: { dashboard: "👨‍🏫 Teacher Dashboard", logout: "Logout", upload: "🎥 Upload Video", students: "👨‍🎓 Students & Quiz Scores", uploadBtn: "Upload" },
      pa: { dashboard: "👨‍🏫 ਅਧਿਆਪਕ ਡੈਸ਼ਬੋਰਡ", logout: "ਲਾੱਗ ਆਊਟ", upload: "🎥 ਵੀਡੀਓ ਅਪਲੋਡ ਕਰੋ", students: "👨‍🎓 ਵਿਦਿਆਰਥੀ ਅਤੇ ਕੁਇਜ਼ ਸਕੋਰ", uploadBtn: "ਅਪਲੋਡ ਕਰੋ" }
    }

    function applyLang(lang) {
      const txt = uiTexts[lang]
      document.getElementById('navTitle').textContent = txt.dashboard
      document.getElementById('logoutBtn').textContent = txt.logout
      document.getElementById('uploadTitle').textContent = txt.upload
      document.getElementById('studentTitle').textContent = txt.students
      document.getElementById('uploadBtn').textContent = txt.uploadBtn
    }

    document.getElementById('globalLang').addEventListener('change', e => applyLang(e.target.value))
    applyLang('en')

    // Handle video upload
    document.getElementById("uploadVideoForm").addEventListener("submit", async (e) => {
      e.preventDefault()
      const title = document.getElementById("videoTitleInput").value
      const description = document.getElementById("videoDescInput").value
      const url = document.getElementById("videoUrlInput").value
      const duration = parseInt(document.getElementById("videoDurationInput").value) || null
      const transcript = document.getElementById("transcriptInput").value

      await videoHandler.uploadVideo({ title, description, url, courseId: null, durationSeconds: duration, transcript })

      e.target.reset()
    })

    // Load students + scores
    async function loadStudents(){
      const { data: students, error } = await supabaseClient
        .from('profiles')
        .select('id, full_name, last_active')
        .eq('role','student')

      const table = document.getElementById('studentsTable')
      if(error || !students){ table.innerHTML = <tr><td colspan="4">Error loading</td></tr>; return }

      let rows = ''
      for(const st of students){
        const { data: scores } = await supabaseClient
          .from('quiz_attempts')
          .select('score,total_marks')
          .eq('student_id',st.id)
        const avg = scores && scores.length ? (scores.reduce((s,a)=>s+a.score,0)/scores.length).toFixed(1) : '-'
        rows += `<tr onclick="viewStudentDetails('${st.id}','${st.full_name}')">
          <td>${st.full_name || '(no name)'}</td>
          <td>${st.last_active ? new Date(st.last_active).toLocaleString() : '-'}</td>
          <td>${avg}</td>
          <td>${scores ? scores.length : 0}</td>
        </tr>`
      }
      table.innerHTML = rows
    }
    loadStudents()

    async function viewStudentDetails(studentId, studentName){
      document.getElementById('studentDetailName').textContent = studentName;
      document.getElementById('studentDetailModal').style.display = 'flex';

      const { data: attempts, error } = await supabaseClient
        .from('quiz_attempts')
        .select('quiz_id, score, total_marks, is_completed, quizzes(title)')
        .eq('student_id', studentId);

      const tbody = document.getElementById('studentQuizScores');
      if (error || !attempts) {
        tbody.innerHTML = <tr><td colspan="3">Error loading</td></tr>;
        return;
      }
      tbody.innerHTML = attempts.map(a => `
        <tr>
          <td>${a.quizzes?.title || 'Quiz'}</td>
          <td>${a.score}/${a.total_marks}</td>
          <td>${a.is_completed ? '✅ Completed' : '❌ Incomplete'}</td>
        </tr>
      `).join('') || <tr><td colspan="3">No attempts yet</td></tr>;
    }
    document.getElementById('closeStudentDetail').addEventListener('click',()=>document.getElementById('studentDetailModal').style.display='none')
  </script>
</body>
</html>
