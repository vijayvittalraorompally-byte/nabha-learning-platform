<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teacher Dashboard</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <script src="js/auth.js"></script>
  <style>
    body{font-family:Arial;margin:0;background:#f5f7fb}
    .nav{display:flex;justify-content:space-between;padding:1rem;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.06)}
    .container{max-width:1100px;margin:1rem auto;padding:1rem}
    .card{background:#fff;padding:1rem;border-radius:8px;margin-bottom:1rem}
    .btn{background:#667eea;color:#fff;padding:.5rem .8rem;border:none;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <div class="nav">
    <div><strong>üë®‚Äçüè´ Teacher Dashboard</strong> <span id="teacherName" style="color:#666;margin-left:8px">Loading...</span></div>
    <div>
      <button class="btn" id="toHome">Home</button>
      <button class="btn" id="logout">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h3>Create Quiz</h3>
      <div id="qc_container"></div>
    </div>

    <div class="card">
      <h3>Upload Video</h3>
      <form id="videoForm">
        <div><label>Title</label><input id="v_title" required style="width:100%;padding:.5rem"/></div>
        <div style="margin-top:.4rem"><label>Video URL (YouTube or file)</label><input id="v_url" required style="width:100%;padding:.5rem"/></div>
        <div style="margin-top:.4rem"><label>Thumbnail URL (optional)</label><input id="v_thumb" style="width:100%;padding:.5rem"/></div>
        <div style="margin-top:.6rem"><button class="btn" type="submit">Save Video</button></div>
      </form>
      <div id="v_feedback" style="margin-top:.5rem"></div>
    </div>

    <div class="card">
      <h3>My Videos</h3>
      <div id="myVideos">Loading...</div>
    </div>
  </div>

  <script src="js/quiz-creator.js"></script>
  <script src="js/video-handler.js"></script>
  <script>
    (async ()=>{
      // wait a bit so authManager loads
      await new Promise(r=>setTimeout(r,250));
      if (!window.authManager || !window.authManager.isTeacher()) { window.location.replace('dashboard.html'); return; }
      document.getElementById('teacherName').textContent = window.authManager.getDisplayName();
      document.getElementById('logout').addEventListener('click', ()=>window.authManager.signOut());
      document.getElementById('toHome').addEventListener('click', ()=>location.href='index.html');

      // render quiz creator UI
      window.QuizCreator?.renderQuickUI(document.getElementById('qc_container'));

      // handle video form
      document.getElementById('videoForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const video = {
          title: document.getElementById('v_title').value.trim(),
          video_url: document.getElementById('v_url').value.trim(),
          thumbnail_url: document.getElementById('v_thumb').value.trim() || null,
          teacher_id: window.authManager.currentUser?.id,
          created_at: new Date().toISOString()
        };
        const { data, error } = await window.db.createVideo(video);
        const fb = document.getElementById('v_feedback');
        if (error) { fb.textContent = 'Error: ' + (error.message || JSON.stringify(error)); fb.style.color='red'; }
        else { fb.textContent = 'Saved.'; fb.style.color='green'; loadMyVideos(); }
      });

      async function loadMyVideos(){
        const { data, error } = await window.db.getVideos();
        const container = document.getElementById('myVideos');
        if (error) { container.textContent = 'Failed to load'; return; }
        const my = data.filter(v => v.teacher_id === window.authManager.currentUser?.id);
        if (!my.length) { container.textContent = 'No videos yet'; return; }
        container.innerHTML = my.map(v => <div style="padding:.5rem;border-bottom:1px solid #eee"><strong>${v.title}</strong><br/><small>${v.video_url}</small><div style="margin-top:.3rem"><a href="video-player.html?id=${v.id}">Open</a></div></div>).join('');
      }
      loadMyVideos();
    })();
  </script>
</body>
</html>
