<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - Nabha Learning</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <script src="js/auth.js"></script>
  <style>
    body{font-family:Arial, sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;align-items:center;justify-content:center;margin:0;padding:1rem}
    .card{background:#fff;padding:2rem;border-radius:10px;max-width:420px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    .form-group{margin-bottom:1rem}
    label{display:block;margin-bottom:.5rem;font-weight:600}
    input,select{width:100%;padding:.8rem;border:1px solid #ccc;border-radius:6px}
    .btn{background:#667eea;color:#fff;padding:1rem;border:none;border-radius:6px;width:100%;cursor:pointer}
    .toggle{color:#667eea;cursor:pointer;text-decoration:underline;margin-left:8px}
    .message{margin-top:1rem;padding:.8rem;border-radius:6px;display:none}
    .success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="text-align:center">ðŸ“š Nabha Learning</h2>
    <div id="message" class="message"></div>

    <form id="authForm">
      <div class="form-group"><label>Email</label><input id="email" type="email" required /></div>
      <div class="form-group"><label>Password</label><input id="password" type="password" required minlength="6" /></div>

      <div id="signupFields" style="display:none">
        <div class="form-group"><label>Full name</label><input id="name" type="text" /></div>
        <div class="form-group"><label>Role</label>
          <select id="role"><option value="">Select</option><option value="student">Student</option><option value="teacher">Teacher</option></select>
        </div>
        <div class="form-group"><label>School name</label><input id="school_name" type="text" /></div>
        <div class="form-group"><label>Grade level</label>
          <select id="grade_level"><option value="">(optional)</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option></select>
        </div>
      </div>

      <button id="submitBtn" class="btn" type="submit">Login</button>
    </form>

    <p style="text-align:center;margin-top:1rem">
      <span id="switchText">Don't have an account?</span>
      <span id="toggleLink" class="toggle">Sign Up</span>
    </p>
  </div>

  <script>
    const authForm = document.getElementById('authForm');
    const toggleLink = document.getElementById('toggleLink');
    const signupFields = document.getElementById('signupFields');
    const submitBtn = document.getElementById('submitBtn');
    const switchText = document.getElementById('switchText');
    const messageDiv = document.getElementById('message');

    let isSignUp = false;
    toggleLink.addEventListener('click', () => {
      isSignUp = !isSignUp;
      if (isSignUp) {
        signupFields.style.display = 'block';
        submitBtn.textContent = 'Sign Up';
        switchText.textContent = 'Already have an account?';
        toggleLink.textContent = ' Login';
      } else {
        signupFields.style.display = 'none';
        submitBtn.textContent = 'Login';
        switchText.textContent = "Don't have an account?";
        toggleLink.textContent = ' Sign Up';
      }
      messageDiv.style.display = 'none';
    });

    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageDiv.style.display = 'none';

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) return showMessage('Provide email and password','error');

      try {
        if (isSignUp) {
          const name = document.getElementById('name').value.trim();
          const role = document.getElementById('role').value;
          const school = document.getElementById('school_name').value.trim();
          const grade = document.getElementById('grade_level').value;

          if (!name || !role || !school) return showMessage('Fill all signup fields','error');

          await window.authManager.signUp(email, password, name, role, school, grade || null);
          showMessage('Registered. Confirm your email if required.','success');
          setTimeout(()=>window.location.replace('login.html'),1200);
        } else {
          await window.authManager.signIn(email, password);
          showMessage('Login successful. Redirecting...','success');
          setTimeout(()=>window.authManager.redirectToDashboard(),700);
        }
      } catch (err) {
        console.error(err);
        showMessage(err?.message || JSON.stringify(err),'error');
      }
    });

    function showMessage(text,type='error'){
      messageDiv.textContent = text;
      messageDiv.className = 'message ' + (type==='success' ? 'success': 'error');
      messageDiv.style.display = 'block';
    }

    window.addEventListener('load', async () => {
      try {
        const { data: { user } } = await window.auth.getUser();
        if (user) {
          showMessage('Already logged in. Redirecting...','success');
          setTimeout(()=>window.authManager.redirectToDashboard(),700);
        }
      } catch (e){}
    });
  </script>
</body>
</html>
