<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Login - Nabha Learning</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <style>
    .card { max-width:420px;margin:3rem auto;padding:1.5rem;border-radius:10px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    body { background:#f6f8fb; font-family:Arial,Helvetica,sans-serif; color:#222; }
    .btn { padding:.6rem 1rem;border:none;border-radius:8px;cursor:pointer; }
    .btn.primary { background:#667eea;color:#fff; }
    .input { width:100%;padding:.6rem;border:1px solid #ddd;border-radius:6px;margin-bottom:.8rem; }
    .small { font-size:.9rem;color:#666;margin-top:.5rem; }
    .error { color:#b91c1c;margin-top:.6rem; }
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin-top:0">Sign in / Sign up</h2>

    <div id="message" class="small">Enter email and password</div>
    <div id="error" class="error" style="display:none"></div>

    <label>Email</label>
    <input id="email" class="input" type="email" placeholder="you@example.com" />

    <label>Password</label>
    <input id="password" class="input" type="password" placeholder="Choose a secure password" />

    <div style="display:flex;gap:.5rem;margin-top:.5rem;">
      <button id="signInBtn" class="btn primary">Sign In</button>
      <button id="signUpBtn" class="btn" style="background:#eee">Sign Up</button>
    </div>

    <div class="small" style="margin-top:1rem">
      After sign up you will be redirected to the dashboard. Check console for debug logs.
    </div>
  </div>

  <!-- scripts (order matters) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <script src="js/auth.js"></script>

  <script>
    (function () {
      const emailInput = document.getElementById('email');
      const passInput = document.getElementById('password');
      const signInBtn = document.getElementById('signInBtn');
      const signUpBtn = document.getElementById('signUpBtn');
      const errorEl = document.getElementById('error');
      const messageEl = document.getElementById('message');

      function showError(msg) {
        errorEl.style.display = 'block';
        errorEl.textContent = msg;
      }
      function clearError() {
        errorEl.style.display = 'none';
        errorEl.textContent = '';
      }

      async function signup() {
        clearError();
        const email = emailInput.value.trim();
        const password = passInput.value.trim();
        if (!email || !password) { showError('Email and password required'); return; }
        try {
          messageEl.textContent = 'Signing up...';
          const { data, error } = await window.supabaseClient.auth.signUp({
            email, password
          }, { redirectTo: window.location.origin + '/student-dashboard.html' });

          if (error) {
            showError(error.message || 'Signup failed');
            console.error('signup error', error);
            messageEl.textContent = 'Enter email and password';
            return;
          }

          // Signup is often "confirmation required" depending on Supabase settings.
          messageEl.textContent = 'Check your email to confirm (if email confirmations enabled).';
          console.log('signup result', data);
        } catch (err) {
          console.error(err);
          showError(err.message || 'Signup failed');
          messageEl.textContent = 'Enter email and password';
        }
      }

      async function signin() {
        clearError();
        const email = emailInput.value.trim();
        const password = passInput.value.trim();
        if (!email || !password) { showError('Email and password required'); return; }

        try {
          messageEl.textContent = 'Signing in...';
          const { data, error } = await window.supabaseClient.auth.signInWithPassword({ email, password });
          if (error) {
            showError(error.message || 'Sign in failed');
            console.error('signin error', error);
            messageEl.textContent = 'Enter email and password';
            return;
          }

          // Refresh authManager profile
          if (window.authManager && typeof window.authManager._fetchProfile === 'function') {
            try { await window.authManager._fetchProfile(); } catch(e){console.warn(e)}
          }

          console.log('signin result', data);
          // redirect
          window.location.href = 'student-dashboard.html';
        } catch (err) {
          console.error(err);
          showError(err.message || 'Sign in failed');
          messageEl.textContent = 'Enter email and password';
        }
      }

      signUpBtn.addEventListener('click', signup);
      signInBtn.addEventListener('click', signin);

      // quick helper: prefill fields during dev (REMOVE in production)
      // emailInput.value = 'student1@example.com';
      // passInput.value = 'password123';
    })();
  </script>
</body>
</html>
